---
title: "Using collector() for large data sets"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using collector() for large data sets}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




Some of our datasets are large and moving them from that database to your computer can take a fair amount of time.  So long in fact that is not uncommon for our connections to die.^[I don't really understand why this happens].  Additionally, you tend not to get a lot of feedback when using `dplyr`'s `collect()` function to return the data to your computer. It either gets the data silently or dies trying.

For this reason, `ideadata` has a `collector()` function.  It's used the same way as `collect`, but requires you to pass parameters (i.e., column names for the table you are trying to collect ) that are used to break your data into pieces based on the set of values within the columns you identify. 

Consider the `StudentDailyAttendance` table on `PROD1`

```r
devtools::load_all(".")
#> â„¹ Loading ideadata
#library(ideadata)
library(dplyr)
library(lubridate)

stu_attendance  <- get_student_daily_attendance()

glimpse(stu_attendance)
#> Rows: ??
#> Columns: 49
#> Database: Microsoft SQL Server 13.00.5888[IPS\christopher.haid@1065574-SQLPRD1/PROD1]
#> $ AcademicYear         [3m[38;5;246m<chr>[39m[23m "2020-2021", "2020-2021", "2020-2021", "2020-2021", "2020-2021", "2020â€¦
#> $ SchoolTermID         [3m[38;5;246m<dbl>[39m[23m 3000, 3000, 3000, 3000, 3000, 3000, 3000, 3000, 3000, 3000, 3000, 3000â€¦
#> $ SchoolName           [3m[38;5;246m<chr>[39m[23m "IDEA Frontier College Preparatory", "IDEA Academy Primary", "IDEA Edgâ€¦
#> $ schoolnumber         [3m[38;5;246m<dbl>[39m[23m 108807003, 3, 109907024, 109907003, 108807117, 108807195, 108807037, 1â€¦
#> $ StateSchoolNumber    [3m[38;5;246m<dbl>[39m[23m 108807003, 108807101, 108807202, 108807040, 108807117, 108807195, 1088â€¦
#> $ SchoolShortName      [3m[38;5;246m<chr>[39m[23m "Frontier", "Donna", "Edgecliff", "Rio Vista", "Tres Lagos", "Harlingeâ€¦
#> $ SchoolType           [3m[38;5;246m<chr>[39m[23m "College Prep", "Academy", "College Prep", "College Prep", "Academy", â€¦
#> $ VPofSchools          [3m[38;5;246m<dbl>[39m[23m 175, 5779, 9888, 5124, 5062, 175, 6158, 5062, 5062, 5062, 463, 5779, 5â€¦
#> $ VPofSchoolsName      [3m[38;5;246m<chr>[39m[23m "Alex Anzaldua", "Stephanie Sullenger", "Christine Diaz", "Rebecca Cobâ€¦
#> $ RegionID             [3m[38;5;246m<dbl>[39m[23m 7, 7, 9, 5, 7, 7, 1, 7, 7, 7, 2, 7, 7, 1, 1, 9, 7, 2, 1, 7, 1, 1, 7, 5â€¦
#> $ RegionDescription    [3m[38;5;246m<chr>[39m[23m "Rio Grande Valley", "Rio Grande Valley", "Tarrant County", "El Paso",â€¦
#> $ GradeLevelID         [3m[38;5;246m<dbl>[39m[23m 11, 0, 6, 7, 4, 0, 10, 8, 8, 8, 6, 1, 2, 6, 3, 1, 2, 6, 7, 9, 5, 7, 1,â€¦
#> $ GradeLevel           [3m[38;5;246m<chr>[39m[23m "11", "K", "6", "7", "4", "K", "10", "8", "8", "8", "6", "1", "2", "6"â€¦
#> $ AttStudentKey        [3m[38;5;246m<dbl>[39m[23m 42609066, 42609067, 42609068, 42609069, 42609070, 42609071, 42610932, â€¦
#> $ StudentNumber        [3m[38;5;246m<dbl>[39m[23m 108006521, 108087122, 108114827, 108088137, 108064960, 108110230, 1080â€¦
#> $ FirstName            [3m[38;5;246m<chr>[39m[23m "Angel", "Bella", "Daisy", "Lorenzo", "Jesus", "Carolina", "Katty", "Câ€¦
#> $ LastName             [3m[38;5;246m<chr>[39m[23m "Duran", "Soto", "Torres", "Escobedo", "Cantu", "Flores", "Alvarado", â€¦
#> $ FullName             [3m[38;5;246m<chr>[39m[23m "Duran, Angel Gabriel", "Soto, Bella Rose", "Torres, Daisy", "Escobedoâ€¦
#> $ WeekNumber           [3m[38;5;246m<chr>[39m[23m "38", "38", "38", "38", "38", "38", "38", "38", "38", "38", "38", "38"â€¦
#> $ DateNumber           [3m[38;5;246m<int>[39m[23m 157, 157, 156, 148, 157, 157, 155, 157, 157, 157, 155, 157, 157, 155, â€¦
#> $ AttDate              [3m[38;5;246m<date>[39m[23m 2021-04-30, 2021-04-30, 2021-04-30, 2021-04-30, 2021-04-30, 2021-04-3â€¦
#> $ Membership           [3m[38;5;246m<dbl>[39m[23m 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, â€¦
#> $ Absences             [3m[38;5;246m<dbl>[39m[23m 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0â€¦
#> $ VAbsences            [3m[38;5;246m<dbl>[39m[23m 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0â€¦
#> $ SPED                 [3m[38;5;246m<int>[39m[23m 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0â€¦
#> $ ELL                  [3m[38;5;246m<int>[39m[23m 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0â€¦
#> $ LEP                  [3m[38;5;246m<int>[39m[23m 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0â€¦
#> $ Farm                 [3m[38;5;246m<int>[39m[23m 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1â€¦
#> $ CSI                  [3m[38;5;246m<int>[39m[23m 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0â€¦
#> $ NonSpedEllCsi        [3m[38;5;246m<int>[39m[23m 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 1, 0, 1, 1â€¦
#> $ Ethnicity            [3m[38;5;246m<chr>[39m[23m "White", "White", "White", "White", "White", "White", "White", "White"â€¦
#> $ Hispanic             [3m[38;5;246m<int>[39m[23m 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1â€¦
#> $ ContinuouslyEnrolled [3m[38;5;246m<chr>[39m[23m "True", "False", "False", "False", "True", "False", "False", "True", "â€¦
#> $ AtRisk               [3m[38;5;246m<int>[39m[23m 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0â€¦
#> $ PersistenceType      [3m[38;5;246m<int>[39m[23m 3, 3, 1, 3, 3, 1, 3, 3, 3, 3, 1, 3, 1, 3, 1, 1, 3, 3, 3, 3, 1, 3, 3, 1â€¦
#> $ SchoolYear           [3m[38;5;246m<chr>[39m[23m "2+", "2+", "1", "2+", "2+", "1", "2+", "2+", "2+", "2+", "2+", "2+", â€¦
#> $ DayAfterEvent        [3m[38;5;246m<chr>[39m[23m NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NAâ€¦
#> $ EventDate            [3m[38;5;246m<date>[39m[23m NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, Nâ€¦
#> $ MaxTempinF           [3m[38;5;246m<dbl>[39m[23m 78.3, 78.3, 67.5, NA, 78.3, 78.3, 68.9, 78.3, 78.3, 78.3, 74.5, 78.3, â€¦
#> $ AvgTempInF           [3m[38;5;246m<dbl>[39m[23m 74.6, 74.6, 63.1, NA, 74.6, 74.6, 68.2, 74.6, 74.6, 74.6, 68.6, 74.6, â€¦
#> $ MinTempInF           [3m[38;5;246m<dbl>[39m[23m 71.4, 71.4, 59.2, NA, 71.4, 71.4, 65.3, 71.4, 71.4, 71.4, 66.2, 71.4, â€¦
#> $ CompareKey           [3m[38;5;246m<chr>[39m[23m "175|Alex Anzaldua|7|Rio Grande Valley|3000|108807003|11|108006521|202â€¦
#> $ RdoEmployeeID        [3m[38;5;246m<dbl>[39m[23m 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0â€¦
#> $ RdoEmployeeName      [3m[38;5;246m<chr>[39m[23m "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", ""â€¦
#> $ SchoolTypeOperation  [3m[38;5;246m<chr>[39m[23m "FULL SCALE", "FULL SCALE", "LAUNCHING", "FULL SCALE", "FULL SCALE", "â€¦
#> $ Enroll               [3m[38;5;246m<int>[39m[23m 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1â€¦
#> $ Area                 [3m[38;5;246m<chr>[39m[23m NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NAâ€¦
#> $ SubRegionID          [3m[38;5;246m<dbl>[39m[23m NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NAâ€¦
#> $ SubRegionDescription [3m[38;5;246m<chr>[39m[23m NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NAâ€¦
```

```r

#school years are stored as characters, which is inefficient for filtering
# TermIDs are doubles (thought they really ought be integers), but are 
# much faster for filtering. 

term_id <- calc_ps_termid(2021)


stu_attend_2021 <- stu_attendance %>% 
  filter(SchoolTermID == term_id)

n_rows <- stu_attend_2021 %>% 
  count() %>% 
  pull()

n_rows
#> [1] 3723612
```
So as of the October 21, 2021 there are 3,723,612	student attendance records. That will be a tall order for `collect` so instead lets use `collector`.

`collector` takes column names, uses thosecolumns to get all combinations of variables that appear in the data, and then uses those combinations to pull your data down in smaller chunks defined be each combination (e.g., for each school and data, as shown below). 


```r
collection_data_start <- today() - days(2)

stu_attend_2021_temp <- stu_attendance %>% 
  select(StudentNumber, AttDate, schoolnumber , Membership, Absences) %>% 
  filter(AttDate >= '2021-10-08', 
         SchoolNumber %in% c('108807186', '108807187', '108807302', '109907024')) %>%  

  compute()
#> Created a temporary table named #dbplyr_007

 
stu_attend_2021_collected <-  stu_attend_2021_temp %>% 
  collector(AttDate, schoolnumber) %>% 
  janitor::clean_names()
#> Collecting data
#> Pulling data filtered to: AttDate == '2021-10-08', schoolnumber == '108807186' ...
#> Pulling data filtered to: AttDate == '2021-10-08', schoolnumber == '108807187' ...
#> Pulling data filtered to: AttDate == '2021-10-08', schoolnumber == '108807302' ...
#> Pulling data filtered to: AttDate == '2021-10-08', schoolnumber == '109907024' ...
#> Pulling data filtered to: AttDate == '2021-10-12', schoolnumber == '108807186' ...
#> Pulling data filtered to: AttDate == '2021-10-12', schoolnumber == '108807187' ...
#> Pulling data filtered to: AttDate == '2021-10-12', schoolnumber == '108807302' ...
#> Pulling data filtered to: AttDate == '2021-10-12', schoolnumber == '109907024' ...
#> Pulling data filtered to: AttDate == '2021-10-13', schoolnumber == '108807186' ...
#> Pulling data filtered to: AttDate == '2021-10-13', schoolnumber == '108807187' ...
#> Pulling data filtered to: AttDate == '2021-10-13', schoolnumber == '108807302' ...
#> Pulling data filtered to: AttDate == '2021-10-13', schoolnumber == '109907024' ...
#> Pulling data filtered to: AttDate == '2021-10-14', schoolnumber == '108807186' ...
#> Pulling data filtered to: AttDate == '2021-10-14', schoolnumber == '108807187' ...
#> Pulling data filtered to: AttDate == '2021-10-14', schoolnumber == '108807302' ...
#> Pulling data filtered to: AttDate == '2021-10-14', schoolnumber == '109907024' ...
#> Pulling data filtered to: AttDate == '2021-10-18', schoolnumber == '108807186' ...
#> Pulling data filtered to: AttDate == '2021-10-18', schoolnumber == '108807187' ...
#> Pulling data filtered to: AttDate == '2021-10-18', schoolnumber == '108807302' ...
#> Pulling data filtered to: AttDate == '2021-10-18', schoolnumber == '109907024' ...
#> Pulling data filtered to: AttDate == '2021-10-19', schoolnumber == '108807186' ...
#> Pulling data filtered to: AttDate == '2021-10-19', schoolnumber == '108807187' ...
#> Pulling data filtered to: AttDate == '2021-10-19', schoolnumber == '108807302' ...
#> Pulling data filtered to: AttDate == '2021-10-19', schoolnumber == '109907024' ...
#> Pulling data filtered to: AttDate == '2021-10-20', schoolnumber == '108807186' ...
#> Pulling data filtered to: AttDate == '2021-10-20', schoolnumber == '108807187' ...
#> Pulling data filtered to: AttDate == '2021-10-20', schoolnumber == '108807302' ...
#> Pulling data filtered to: AttDate == '2021-10-20', schoolnumber == '109907024' ...
#> Pulling data filtered to: AttDate == '2021-10-21', schoolnumber == '108807186' ...
#> Pulling data filtered to: AttDate == '2021-10-21', schoolnumber == '108807187' ...
#> Pulling data filtered to: AttDate == '2021-10-21', schoolnumber == '108807302' ...
#> Pulling data filtered to: AttDate == '2021-10-21', schoolnumber == '109907024' ...
#> Data collection complete
```



Note the call to `dplyr::compute()` in the code above (highlighted).



What is that `compute()` call doing?

`compute()` forces the database to evaluate all the prior steps (i.e. a filter, a select, and another filter), after which the will create a temporary table there (i.e., a table which get's deleted when your conenction closes.  

Wihout this step each iteration created by `collector()` (via `purrr::map_df()`) will re run the the magrittr pipeline, of which the tw filter steps are computationally expensive. 
A caveat with this desing pattern is you need to have permissions to write temporary tables to the database.  If you can't do that, then you'll have to suffer the pain of waiting for the DB to run all of your `magrittr` pipeline (i.e., all the stuff following each `%>%`) for each iteration.  

In any case, here are the results of the call, witht eh student numbers masked by an sha1 cryptohash:


```r
stu_attend_2021_feb %>% 
  head(20) %>% 
  mutate(student_number = openssl::sha1(as.character(student_number))) %>% #crypto hash
  knitr::kable()
#> Error in head(., 20): object 'stu_attend_2021_feb' not found
```

Notice that the table `stu_attendance` (i.e, `STudentDailyAttendance` on `PROD1`) has 49 columns.  A trick used above is to reduce  the columns to only those you need to use later with a `select` statement early in the data pipeline; doing so greatly reduces the amount of data you are requesting from the database. 
