---
title: "Using collector() for large data sets"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using collector() for large data sets}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




Some of our datasets are large and moving them from that database to your computer can take a fare amount of time.  So long in fact that is not uncommon for our connections to die.^[I don't really understand why this happens].  Additionally, you tend not to get a log of feedback when using `dplyr`'s `collect()` function to return the data to your computer. It either gets the data silently or dies trying.

For this reason, `ideadata` has a `collector` function.  It's used the same way as `collect`, but requires you to pass a paramater---`.split_column` that is used to break your data into pieces based on the set of values with in the column you identify. 

Consider the `StudentDailyAttendance` table on `PROD1`

```r
devtools::load_all(".")
#> Loading ideadata
#library(ideadata)
library(dplyr)

stu_attendance  <- get_student_daily_attendance()
#> christopher.haid's Kereberos TGT is current

glimpse(stu_attendance)
#> Rows: ??
#> Columns: 46
#> Database: Microsoft SQL Server 13.00.5865[IPS\christopher.haid@1065574-SQLPRD1/PROD1]
#> $ AcademicYear         <chr> "2015-2016", "2015-2016", "2015-2016", "2015-2016"…
#> $ SchoolTermID         <dbl> 2500, 2500, 2500, 2500, 2500, 2500, 2500, 2500, 25…
#> $ SchoolName           <chr> "IDEA Alamo Middle School", "IDEA Quest Academy", …
#> $ schoolnumber         <dbl> 108807047, 108807102, 108807047, 108807048, 108807…
#> $ StateSchoolNumber    <dbl> 108807007, 108807102, 108807007, 108807008, 108807…
#> $ SchoolShortName      <chr> "Alamo", "Quest", "Alamo", "Pharr", "Frontier", "F…
#> $ SchoolType           <chr> "College Prep", "Academy", "College Prep", "Colleg…
#> $ VPofSchools          <dbl> 2596, 5302, 2596, 5779, 175, 175, 1320, 5779, 1986…
#> $ VPofSchoolsName      <chr> "Israel Ybarra", "Rosa Chapa", "Israel Ybarra", "S…
#> $ RegionID             <dbl> 7, 7, 7, 7, 7, 7, 2, 7, 7, 7, 2, 7, 7, 7, 7, 2, 2,…
#> $ RegionDescription    <chr> "Rio Grande Valley", "Rio Grande Valley", "Rio Gra…
#> $ GradeLevelID         <dbl> 6, 1, 8, 8, 8, 2, 2, 3, 6, 3, 3, 0, 6, 0, 0, 6, 1,…
#> $ GradeLevel           <chr> "6", "1", "8", "8", "8", "2", "2", "3", "6", "3", …
#> $ AttStudentKey        <dbl> 336448, 336449, 336450, 336451, 336452, 336453, 33…
#> $ StudentNumber        <dbl> 108050740, 108034756, 108033943, 108040036, 108003…
#> $ FirstName            <chr> "Kayla", "Jonathan", "Eliezer", "Jacob", "Celest",…
#> $ LastName             <chr> "De La Rosa", "Saenz", "Salazar", "Alejandro", "Ca…
#> $ FullName             <chr> "De La Rosa, Kayla Ruby", "Saenz, Jonathan", "Sala…
#> $ WeekNumber           <chr> "3", "3", "3", "3", "3", "3", "3", "3", "3", "3", …
#> $ DateNumber           <int> 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15…
#> $ AttDate              <date> 2015-08-28, 2015-08-28, 2015-08-28, 2015-08-28, 2…
#> $ Membership           <dbl> 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, …
#> $ Absences             <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,…
#> $ VAbsences            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,…
#> $ SPED                 <int> 0, NA, 0, 0, NA, 0, 0, NA, 0, 0, 0, 0, NA, 0, 0, 0…
#> $ ELL                  <int> 0, NA, 0, 1, NA, 1, 0, NA, 0, 1, 1, 1, NA, 1, 1, 0…
#> $ LEP                  <int> 0, NA, 0, 1, NA, 1, 0, NA, 0, 1, 1, 1, NA, 1, 1, 0…
#> $ Farm                 <int> 1, NA, 1, 1, NA, 1, 0, NA, 1, 0, 1, 1, NA, 1, 1, 1…
#> $ CSI                  <int> 0, NA, 0, 0, NA, 0, 0, NA, 0, 0, 0, 0, NA, 0, 0, 0…
#> $ NonSpedEllCsi        <int> 1, NA, 1, 0, NA, 0, 1, NA, 1, 0, 0, 0, NA, 0, 0, 1…
#> $ Ethnicity            <chr> "White", NA, "White", "White", NA, "White", "White…
#> $ Hispanic             <int> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
#> $ ContinuouslyEnrolled <chr> "1", "0", "1", "1", "0", "1", "1", "0", "1", "1", …
#> $ AtRisk               <int> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
#> $ PersistenceType      <int> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
#> $ SchoolYear           <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
#> $ DayAfterEvent        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
#> $ EventDate            <date> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
#> $ MaxTempinF           <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
#> $ AvgTempInF           <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
#> $ MinTempInF           <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
#> $ CompareKey           <chr> "2596|Israel Ybarra|7|Rio Grande Valley|2500|10880…
#> $ RdoEmployeeID        <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
#> $ RdoEmployeeName      <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
#> $ SchoolTypeOperation  <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
#> $ Enroll               <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
```

```r

#school years are stored as characters, which is inefficient for filtering
# TermIDs are doubles (thought they really ought be integers), but are 
# much faster for filtering. 
term_id <- calc_ps_termid(2020)


stu_attend_2021 <-stu_attendance %>% 
  filter(SchoolTermID == term_id)

stu_attend_2021 %>% 
  count()
#> # Source:   lazy query [?? x 1]
#> # Database: Microsoft SQL Server
#> #   13.00.5865[IPS\christopher.haid@1065574-SQLPRD1/PROD1]
#>         n
#>     <int>
#> 1 8423824
```
So as of the February 26th, 2021 there 7,907,580 student attendance records. That will be a tall order for `collect` so instead lets use `collector`


```r

stu_attend_2021_feb <- stu_attendance %>% 
  select(StudentNumber, AttDate, Membership, Absences) %>% 
  filter(AttDate >= '2021-02-15 00:00') %>%  
  collector(AttDate) %>% 
  janitor::clean_names()
#> Collecting data
#> Pulling data for AttDate == 2021-02-16 ...
#> Pulling data for AttDate == 2021-02-17 ...
#> Pulling data for AttDate == 2021-02-18 ...
#> Pulling data for AttDate == 2021-02-19 ...
#> Pulling data for AttDate == 2021-02-22 ...
#> Pulling data for AttDate == 2021-02-23 ...
#> Pulling data for AttDate == 2021-02-24 ...
#> Pulling data for AttDate == 2021-02-25 ...
#> Pulling data for AttDate == 2021-02-26 ...
#> Pulling data for AttDate == 2021-03-01 ...
#> Pulling data for AttDate == 2021-03-02 ...
#> Pulling data for AttDate == 2021-03-03 ...
#> Pulling data for AttDate == 2021-03-04 ...
#> Pulling data for AttDate == 2021-03-05 ...
#> Pulling data for AttDate == 2021-03-08 ...
#> Pulling data for AttDate == 2021-03-09 ...
#> Pulling data for AttDate == 2021-03-10 ...
#> Pulling data for AttDate == 2021-03-11 ...
#> Pulling data for AttDate == 2021-03-15 ...
#> Pulling data for AttDate == 2021-03-16 ...
#> Data collection complete
```

```r
stu_attend_2021_feb %>% 
  head(20) %>% 
  mutate(student_number = openssl::sha1(as.character(student_number))) %>% #crypto hash
  knitr::kable()
```



|student_number                           |att_date   | membership| absences|
|:----------------------------------------|:----------|----------:|--------:|
|a2f96816e1fe5cec313f7e3e0595f72479d8b12e |2021-02-16 |          1|        1|
|9a507398b859e777182a82ee103c2edb7810a485 |2021-02-16 |          1|        1|
|2620c1902a05ea596a1e55c145395fd38632c0b3 |2021-02-16 |          1|        1|
|72a60ec51f1d527be064fc1506d6a0130a473ce7 |2021-02-16 |          1|        0|
|66a9102da16438c01a9fe0258f7c72ce63feece6 |2021-02-16 |          1|        0|
|0818abe48119841f8fad099b5dabbd630fecf469 |2021-02-16 |          1|        1|
|6fcbb1628caf394cfa0d7b749794116c55378605 |2021-02-16 |          1|        0|
|5ab7556a6e391f87e63c45bff64a3b81b81f7089 |2021-02-16 |          1|        0|
|cf8e4fceb916f298bc80c89d51614c7ca67d6160 |2021-02-16 |          1|        0|
|a1e17c63661e429b624ee34aaea76ce6583bb3b4 |2021-02-16 |          1|        1|
|8525a30cf0d3e82b7af4c90369d1646175597523 |2021-02-16 |          1|        1|
|5e42e70d845c26a953ca595a95f91a951029c8c9 |2021-02-16 |          1|        0|
|7e06d765484c545e3291bfb09d3124b72e51a7fd |2021-02-16 |          1|        0|
|f550905b31d1ba69fdfe13c8e23b1fc85a1b8ce9 |2021-02-16 |          1|        0|
|c8144720539ad5b24ec6543923872107bdcf0959 |2021-02-16 |          1|        0|
|7d2b01852171f31a954fb6714a74efedb7c61ae4 |2021-02-16 |          1|        0|
|c5e41fd5f863022221bf01a376069349e7b8a824 |2021-02-16 |          1|        0|
|69d3db9b02fb1d184946fcccc4a9e902d7dc0a2a |2021-02-16 |          1|        0|
|ad1e0f539cb63c77aab993e5d9d0f783858c75c6 |2021-02-16 |          1|        0|
|418ad4ee7a1ac273eb0864b7b57e2184a6fb10ea |2021-02-16 |          1|        0|

Notice that the table `stu_attendance` (i.e, `STudentDailyAttendance` on `PROD1`) has 46 columns.  A trick used above is to reduce  the columns to only those you need to use later with a `select` statement early in the data pipeline; doing so greatly reduces the amount of data you are requesting from the database. 
